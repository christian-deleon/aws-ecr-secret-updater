apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-script
data:
  update-ecr-secret.sh: |
    #!/bin/sh -e

    if [ -z "$NAMESPACES" ]; then
      echo "No namespaces provided"
      exit 1
    fi

    REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    PASSWORD=$(aws ecr get-login-password --region $AWS_REGION)

    if [ -z "$PASSWORD" ]; then
      echo "Failed to get login password"
      exit 1
    fi

    for ns in $NAMESPACES; do
      echo "Updating secret in namespace: $ns"

      # Create or update the secret
      kubectl create secret docker-registry $SECRET_NAME \
          --docker-server=$REGISTRY \
          --docker-username=AWS \
          --docker-password=$PASSWORD \
          --dry-run=client -o yaml | kubectl apply -f - -n $ns

      # Patch the default service account if enabled
      if [ "$PATCH_DEFAULT_SA" = "true" ]; then
          echo "Patching default service account in namespace: $ns"
          kubectl patch serviceaccount default -n $ns --type merge -p "{\"imagePullSecrets\": [{\"name\": \"$SECRET_NAME\"}]}"
      fi
    done
